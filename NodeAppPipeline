pipeline {
    agent any

    environment {
        NODEJS_VERSION = '14' // Change the version as needed
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Update nvm') {
            steps {
                script {
                    // Update nvm using Git
                    dir("$HOME/.nvm") {
                        sh 'git pull origin master' // You may need to change the branch name if it's different
                    }

                    // Source nvm.sh
                    sh '. "$HOME/.nvm/nvm.sh"'

                    // Install or use the desired Node.js version
                    sh "nvm install ${NODEJS_VERSION}"
                    sh "nvm use ${NODEJS_VERSION}"

                    // Set the npm and node commands to use the installed versions
                    def npmCMD = "${NVM_BIN}/npm"
                    def nodeCMD = "${NVM_BIN}/node"
                    
                    // Install Node.js dependencies
                    sh "${npmCMD} install"
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    // Run your Node.js tests
                    sh "${npmCMD} test"
                }
            }
        }

        stage('Build and Deploy') {
            steps {
                script {
                    // Additional steps for building and deploying your Node.js application
                    // For example, you might want to bundle your application or push it to a server
                    // Modify this stage based on your specific deployment needs
                }
            }
        }
    }

    post {
        always {
            // Cleanup steps, if needed
        }
    }
}
